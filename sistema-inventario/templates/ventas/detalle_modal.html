{% if modal_content_only %}
    <!-- ======================================================= -->
    <!-- ESTE BLOQUE SE RENDERIZA CUANDO ES LLAMADO POR AJAX -->
    <!-- ======================================================= -->
    <table class="table table-bordered table-sm">
        <thead class="table-secondary">
            <tr>
                <th>Producto</th>
                <th class="text-center">Cantidad</th>
                <th class="text-end">Precio Unitario</th>
                <th class="text-end">Subtotal</th>
            </tr>
        </thead>
        <tbody id="detalle-tabla-body">
            {% if detalles %}
                
                {% for item in detalles %}
                <tr>
                    <td>{{ item.producto_nombre }}</td>
                    <td class="text-center">{{ item.cantidad }}</td>
                    <td class="text-end">${{ '{:,.2f}'.format(item.precio_unitario) }}</td>
                    <td class="text-end">${{ '{:,.2f}'.format(item.subtotal) }}</td>
                </tr>
                {% endfor %} 
                
                <!-- Fila del Total de la Venta (usando el valor de la tabla 'ventas') -->
                <tr class="table-success fw-bold">
                    <td colspan="3" class="text-end">TOTAL VENTA:</td>
                    <td class="text-end text-lg text-primary">${{ '{:,.2f}'.format(venta_info.total) }}</td>
                </tr>
            {% else %}
                <tr><td colspan="4" class="text-center text-danger">No se encontraron productos para esta venta.</td></tr>
            {% endif %}
        </tbody>
    </table>

    <div class="mt-3 p-2 bg-light rounded border">
        <p class="mb-1"><strong>Local de Venta:</strong> {{ venta_info.local_nombre }}</p>
        <p class="mb-0"><strong>Fecha de Venta:</strong> {{ venta_info.fecha.strftime('%Y-%m-%d %H:%M') }}</p>
    </div>

{% else %}
    <!-- ======================================================= -->
    <!-- ESTE BLOQUE SE RENDERIZA CUANDO ES INCLUIDO EN ventas.html -->
    <!-- Contiene la estructura base del modal y el JS para la carga AJAX. -->
    <!-- ======================================================= -->
    <div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="detalleModalLabel">Detalle de Venta ID <span id="modal-venta-id"></span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-content-area">
                    <!-- Placeholder de carga inicial -->
                    <div class="text-center text-muted">Cargando detalles...</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // JS para hacer la petición a la ruta de Flask y recibir HTML
        const detalleModal = document.getElementById('detalleModal');
        detalleModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const idVenta = button.getAttribute('data-id');

            const modalVentaId = detalleModal.querySelector('#modal-venta-id');
            modalVentaId.textContent = idVenta;

            const modalContentArea = detalleModal.querySelector('#modal-content-area');
            
            // Mostrar spinner de carga
            modalContentArea.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><p class="mt-2">Cargando detalles...</p></div>';

            // Petición FETCH que espera una respuesta de TEXTO (HTML)
            fetch(`/ventas/detalle/${idVenta}`)
                .then(response => response.text()) 
                .then(html => {
                    modalContentArea.innerHTML = html; // Inyecta el HTML renderizado por Flask
                })
                .catch(error => {
                    console.error('Error al obtener detalles de venta:', error);
                    modalContentArea.innerHTML = '<div class="alert alert-danger text-center">Error al cargar los datos. Intente de nuevo.</div>';
                });
        });
    </script>
{% endif %}